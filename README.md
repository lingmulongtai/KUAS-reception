<!-- Language: JA | EN -->
[日本語 (JA)](README.md) | [English (EN)](README_ENG.md)

## KUAS Reception アプリ（完全ローカル対応）

### 概要
京都先端科学大学 工学部オープンキャンパス向けの「ミニキャップストーン体験」受付アプリです。予約者・当日参加者の受付、希望プログラム選択、管理用の編集・割り当て・名簿プレビュー、進行表示、エクスポートまでをブラウザだけで完結します。

本プロジェクトは「完全ローカル対応」です。外部CDNは不使用で、必要なライブラリ・アイコン・フォントはすべて本リポジトリに同梱済みです。

## 目次
- [動作環境](#動作環境)
- [起動方法](#起動方法)
- [当日の使用方法](#当日の使用方法)
- [画面と操作](#画面と操作)
- [管理画面](#管理画面歯車アイコン--パスワード-admin)
- [名簿Excelのフォーマット](#名簿excelのフォーマット)
- [データ保存仕様（ローカル）](#データ保存仕様ローカル)
- [セキュリティとプライバシー](#セキュリティとプライバシー)
- [オフライン運用](#オフライン運用)
- [出力（エクスポート）](#出力エクスポート)
- [ディレクトリ構成](#ディレクトリ構成)
- [既知の注意点](#既知の注意点)
- [ライブラリ](#ライブラリ)
- [トラブルシュート](#トラブルシュート)

### 主な機能
- **来場者受付**: 予約あり/なしを切り替えて受付。氏名で予約照合、当日参加は学校名・学年も入力。
- **プログラム選択**: 第1〜第3希望を選択。満員プログラムは選択不可。重複選択を防止。
- **自動割り当て/待機**: 設定（予約者優先、学年優先）に基づき割り当て。満員時は待機。
- **管理画面**: プログラム編集（並べ替え/追加/定員/日英タイトル・説明、JSON編集）、名簿プレビュー、受付状況の可視化（カード/表）。
- **名簿インポート**: 予約者名簿（xlsx）、工学部説明会名簿（xlsx）を読み込み、検索/ステータス表示。
- **エクスポート**: 確定済みの割り当てをExcel（`reception_status.xlsx`）に出力。
- **多言語/テーマ**: 日本語/英語切替、ライト/ダークテーマ切替。
- **保存/復元**: 入力中フォーム、受付データ、名簿データ、設定をローカル保存/自動復元。

## 動作環境
- 推奨ブラウザ: 最新版の Chrome / Edge
- OS: Windows / macOS（Windowsで動作確認）
- ネットワーク: オンライン（CDNからフォント/アイコン/ライブラリを取得）

## 起動方法
1. このフォルダを任意の場所に配置。
2. ブラウザで `index.html` を開くと起動します。
3. 初回は名簿未読込みの通知が出ます。管理画面から名簿を読み込んでください。

## 当日の使用方法
1) 準備
- Windows 10/11 と最新の Edge/Chrome を用意。
- フォルダ構成のままPCへ配置（`index.html`, `script.js`, `style.css`, `assets/`, `vendor/` など）。
- 可能なら簡易ローカルサーバー（任意）で起動:
  - Python: `py -m http.server 8080` → `http://localhost:8080/`
  - Node: `npm -g i serve && serve -l 8080`
- ブラウザでポップアップ許可（Excel/PDF書き出し用）。

2) 名簿のインポート（管理画面 → ファイル読み込み）
- ① 体験 予約者名簿（xlsx）を読み込み、列マッピングで 氏名/フリガナ/第1〜第3希望/同伴者 を設定。
- ② 説明会 参加者名簿（xlsx）を読み込み、列マッピングで 氏名/フリガナ/時間/同伴者 を設定。
- 読み込み後はローカル保存され、再読み込みしても保持されます（IndexedDB）。

3) 受付フロー
- 予約あり: 氏名で照合 → 確認画面に 同伴者人数 を含めて表示 → 確定。
  - 予約時に希望未入力なら希望選択へ。希望選択画面に 同伴者人数(0〜5) のプルダウンあり。
- 予約なし: 氏名/学校/学年/同伴者人数(0〜5) を入力 → 希望選択 → 確定。
- 体験不参加: 専用の完了画面にチェックアイコン・説明会案内・時刻（名簿にあれば）を表示。

4) 配色ストラップの案内
- 確定画面に「あなたは『赤色』です。」（説明文付き）を表示。
- 予約なしで待機となった場合も、同文を表示しつつ「プログラムは後ほど割り当てられます。」を強調表示。

5) 管理パネル運用
- 名簿プレビュー: 予約/説明会とも フリガナ・同伴者 を表示（同伴者は>0が存在する時に列表示、0は空欄）。
- 受付状況: カード/表表示の切替に対応。表表示では確定表の列順を「参加者一覧 → 受付状況（人）」に変更済み。
- 待機者を一括割り当て: 設定（予約者優先/学年優先）に従い割り当て。

6) 保存と復元
- 入力中フォーム（同伴者含む）/名簿/受付データ/設定は自動保存。再読み込みで自動復元。
- リセットは「設定」タブの「受付データをリセット」から（IndexedDB/localStorageを含めて削除）。

7) エクスポート
- Excel/PDFに確定状況を書き出し。参加者ごとに「Companions」列群を追加し同伴者人数を出力（0は空欄）。

## 画面と操作
### トップ（受付）画面のボタン（右上）
- **?（ヘルプ）**: スケジュール画像を表示。
- **月/太陽（テーマ）**: ライト/ダーク切替。
- **Aあ（言語）**: 日本語/英語切替。
- **歯車（管理）**: 管理者ログインへ（初期パスワード: `admin`）。

### 受付フロー
- **予約あり**
  - 氏名を「姓 名」のように半角スペース区切りで入力して予約照合。
  - 予約に希望未入力がある場合は、プログラム選択画面に遷移します。
  - 内容を確認して確定。設定に応じて即割り当て/待機になります。
- **予約なし（当日参加）**
  - 氏名（スペース区切り）/学校名/学年を入力。
  - 「プログラム選択へ」から第1〜第3希望を設定し確定。
  - 体験不参加を選ぶと、説明会のみ参加として案内表示に切り替わります（説明会名簿に時間があれば時刻も表示）。

### プログラム選択
- 各カードの「第1/第2/第3希望」ボタンで選択。重複は不可。
- 定員に達したプログラムは「定員いっぱいです」と表示され選択不可。

## 管理画面（歯車アイコン → パスワード `admin`）
### タブ: プログラム編集
- 並べ替え（左上のリストアイコンをドラッグ）、タイトル/説明/定員の編集、プログラム追加。
- 「英語翻訳表示」をONにすると `タイトル(英) / 説明文(英)` フィールドを表示。英語未入力の場合は既定の英語文で補完します。
- 「JSON表示/編集」からプログラム配列を直接編集可能。
- 「変更を保存」で反映。未保存のままタブ移動/離脱すると確認を出します。

### タブ: ファイル読み込み
- ① ミニキャップストーン体験 予約者名簿（xlsx）を読み込み。
- ② 工学部説明会 参加者名簿（xlsx）を読み込み。
- 読み込み後、名簿データはブラウザに保存され、名簿プレビュー/受付で利用されます。

### タブ: 名簿プレビュー
- 予約者・説明会名簿を一覧表示。検索ボックスで氏名/フリガナ検索が可能。
- 行頭の丸色で受付状況を表示（緑=確定、黄=待機、赤=未受付）。
- 上部に列対応（マッピング）を表示します。
  - フリガナ列はマッピングがなくてもデータに含まれていれば自動表示。
  - 同伴者列は同伴者>0の行が存在する場合に表示（0は空欄）。

### タブ: 受付状況
- プログラムごとの確定人数/定員、参加者をカードまたは表で閲覧。
- 「待機者を一括割り当て」で、設定に応じて待機者をまとめて割り当て。
- 「Excelファイルに書き出し」で確定済みの割り当てをエクスポート。

### タブ: 設定
- **予約者優先割り当て**: ON時、当日参加者は一旦「割り当て待機」。全員受付後に一括割り当て。
- **学年優先割り当て（予約なし）**: ON時、待機者の割り当て順を 高3→高2→高1→その他 に。
- **受付データをリセット**: すべての受付データ/名簿データ/保存状態を削除して再読み込み。

## 名簿Excelのフォーマット
読み込みは下記の固定列を前提にしています（`register_of_names/` にサンプル有）。
- **ミニキャップストーン体験 予約者名簿**
  - A=No, B=姓, C=名, D=セイ, E=メイ, …, O=第1希望, P=第2希望, Q=第3希望, （任意）同伴者列
  - 読み込み後の内部データ: `name`（姓と名を半角スペースで結合）, `furigana`, `choices`（第1〜第3希望の配列）, `companions`
- **工学部説明会 参加者名簿**
  - A=No, B=時間, C=姓, D=名, E=セイ, F=メイ, （任意）同伴者列
  - 読み込み後の内部データ: `name`, `furigana`, `time`, `companions`

## データ保存仕様（ローカル）
- ブラウザの **IndexedDB** と **localStorage** を併用。
- 自動保存/復元対象:
  - 入力途中のフォーム（氏名/学校/学年、選択中の希望、表示セクション）
  - 受付データ（確定済み/待機リスト、各プログラムの在籍数）
  - 名簿データ（予約者/説明会）
  - 設定（予約者優先、学年優先、言語、テーマ）
- クリア方法: 管理画面の「受付データをリセット」。

## セキュリティとプライバシー
- **CSP（Content-Security-Policy）**: `index.html` の `<meta http-equiv="Content-Security-Policy">` をCDN対応に更新済み。
  - 許可ドメイン（例）: `fonts.googleapis.com`, `fonts.gstatic.com`, `cdn.jsdelivr.net`, Firebase 関連 (`www.gstatic.com`, `firestore.googleapis.com` など)
  - 画像はデモとして `images.unsplash.com`, `placehold.co` を許可
- **入力のハードニング**: 入力欄に `autocomplete="off"`, `autocapitalize="off"`, `spellcheck="false"` を設定。
- **XSS対策**: 動的に生成するHTMLは `escapeHTML()` によるサニタイズを実施。
- **PII最小化**: 個人情報を含むログは出力せず、データは外部送信しません（ローカル保存のみ）。
- **リセット手段**: 管理画面「受付データをリセット」で IndexedDB / localStorage の関連データを削除可能。

## オフライン運用
- すべての外部依存（フォント/アイコン/ライブラリ）を `assets/` および `vendor/` に同梱しています。
- `index.html` はローカルファイルのみを参照し、ネットワーク不要で動作します。

## 出力（エクスポート）
- 「Excelファイルに書き出し」を押すと `reception_status.xlsx` を生成します。
  - 列: `プログラム`, `出席/枠数`, `参加者1..n`, `参加者1..n (Companions)`
  - PDF出力も同様に `Companions` 列群を追加して表示します。

## ディレクトリ構成
- `index.html`: アプリ本体（CDN読み込みに変更）
- `style.css`: スタイル（ライト/ダーク対応、アニメーション含む）
- `script.js`: 機能実装（受付ロジック、名簿読み込み、保存/復元、多言語、管理画面など）
- `register_of_names/`: 名簿サンプル（xlsx）
  
（注）ローカルのフォント/ベンダーファイルは不要になりました。容量削減のため `assets/fonts/` と `vendor/`、`public/` は削除可能です。

## 既知の注意点
- 完全ローカル対応のため、外部CDNを利用していません。必要ファイルが不足している場合は `assets/` / `vendor/` 配下の構成をご確認ください。
- 管理者パスワードの初期値は `admin` です。変更する場合は `script.js` 内の該当箇所を修正してください。
- 氏名入力は「姓 名」の半角スペース区切りで照合します（全角スペースは自動で半角に正規化）。

## Firebase 設定（任意のオンライン運用）
Firebase を利用して、管理者のメール/パスワードログインと Firestore への保存を行う場合：

1) Firebase プロジェクトを作成し、Authentication（Email/Password）と Cloud Firestore を有効化。

2) プロジェクト直下に `firebase-config.js` を作成：

```html
// firebase-init.js より前に定義してください
window.firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_APP.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "...",
  appId: "..."
};
```

3) `index.html` を開き、歯車ボタンから管理者ログイン（Firebase で作成した Email/Password）。

4) Firestore セキュリティルール（例。実運用では厳格化してください）

```txt
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isStaff() { return request.auth != null; }

    match /participants/{id} {
      allow create: if true;           // App Check 等で濫用対策を
      allow read, update, delete: if isStaff();
    }
    match /programs/{id} { allow read: if true; allow write: if isStaff(); }
    match /sessions/{id} { allow read: if true; allow write: if isStaff(); }
  }
}
```

## ライブラリ
- SortableJS（ドラッグ&ドロップ）
- SheetJS（Excel 読み書き）
- Phosphor Icons（アイコン）
- フォント: Inter / Noto Sans JP / Zen Maru Gothic（すべてローカル同梱）

## トラブルシュート
- 「予約が見つかりません」: 名簿が未インポートか、氏名のスペース区切り/表記ゆれをご確認ください。
- 「定員いっぱい」: 別プログラムをご案内ください。後でキャンセルが出た場合は「待機者を一括割り当て」をご利用ください。
- 表示が崩れる/初期化したい: 管理画面の「受付データをリセット」を実行し、ページを再読み込みしてください。
- アイコンが表示されない: `vendor/phosphor-icons/Fonts/regular/style.css` と `fill/style.css` が読み込まれているか、`<i class="ph ph-*>` となっているか確認してください。
